import{c as F,u as ce,n as z,d as J,p as G,C as U,e as Q,s as K,m as ue,D as re,t as me}from"./use-translate.39547e32.js";import{c as fe}from"./constant.4d85ecb9.js";import{u as W}from"./use-expose.877c018b.js";import{L as de}from"./index.b9a228ca.js";import{d as X}from"./deep-clone.c68588c0.js";import{u as he}from"./use-touch.30351383.js";import{z as Z,D as ee,E as ge,x as Y,e as r,C as te}from"./vue-libs.71fdcafc.js";import{u as ve}from"./useParent.e4fd6deb.js";import{u as xe}from"./useChildren.edf9a3d1.js";const ne=200,oe=300,be=15,[ae,q]=F("picker-column");function ye(t){const{transform:x}=window.getComputedStyle(t),l=x.slice(7,x.length-1).split(", ")[5];return Number(l)}const se=Symbol(ae),R=t=>J(t)&&t.disabled;var Ce=Z({name:ae,props:{readonly:Boolean,allowHtml:Boolean,className:ce,textKey:{type:String,required:!0},itemHeight:{type:Number,required:!0},swipeDuration:{type:z,required:!0},visibleItemCount:{type:z,required:!0},defaultIndex:{type:Number,default:0},initialOptions:{type:Array,default:()=>[]}},emits:["change"],setup(t,{emit:x,slots:l}){let d,I,b,u,m;const k=ee(),a=ge({index:t.defaultIndex,offset:0,duration:0,options:X(t.initialOptions)}),f=he(),w=()=>a.options.length,P=()=>t.itemHeight*(+t.visibleItemCount-1)/2,M=n=>{n=U(n,0,w());for(let s=n;s<w();s++)if(!R(a.options[s]))return s;for(let s=n-1;s>=0;s--)if(!R(a.options[s]))return s},h=(n,s)=>{n=M(n)||0;const c=-n*t.itemHeight,g=()=>{n!==a.index&&(a.index=n,s&&x("change",n))};d&&c!==a.offset?m=g:g(),a.offset=c},O=n=>{JSON.stringify(n)!==JSON.stringify(a.options)&&(a.options=X(n),h(t.defaultIndex))},C=n=>{d||t.readonly||(m=null,a.duration=ne,h(n,!0))},N=n=>J(n)&&t.textKey in n?n[t.textKey]:n,S=n=>U(Math.round(-n/t.itemHeight),0,w()-1),D=(n,s)=>{const c=Math.abs(n/s);n=a.offset+c/.003*(n<0?-1:1);const g=S(n);a.duration=+t.swipeDuration,h(g,!0)},H=()=>{d=!1,a.duration=0,m&&(m(),m=null)},_=n=>{if(!t.readonly){if(f.start(n),d){const s=ye(k.value);a.offset=Math.min(0,s-P()),I=a.offset}else I=a.offset;a.duration=0,b=Date.now(),u=I,m=null}},E=n=>{if(t.readonly)return;f.move(n),f.isVertical()&&(d=!0,G(n,!0)),a.offset=U(I+f.deltaY.value,-(w()*t.itemHeight),t.itemHeight);const s=Date.now();s-b>oe&&(b=s,u=a.offset)},p=()=>{if(t.readonly)return;const n=a.offset-u,s=Date.now()-b;if(s<oe&&Math.abs(n)>be){D(n,s);return}const g=S(a.offset);a.duration=ne,h(g,!0),setTimeout(()=>{d=!1},0)},$=()=>{const n={height:`${t.itemHeight}px`};return a.options.map((s,c)=>{const g=N(s),V=R(s),B={role:"button",style:n,tabindex:V?-1:0,class:q("item",{disabled:V,selected:c===a.index}),onClick:()=>C(c)},L={class:"van-ellipsis",[t.allowHtml?"innerHTML":"textContent"]:g};return r("li",B,[l.option?l.option(s):r("div",L,null)])})},j=n=>{const{options:s}=a;for(let c=0;c<s.length;c++)if(N(s[c])===n)return h(c)},A=()=>a.options[a.index];return h(a.index),ve(se),W({state:a,setIndex:h,getValue:A,setValue:j,setOptions:O,stopMomentum:H}),Y(()=>t.initialOptions,O),Y(()=>t.defaultIndex,n=>h(n)),()=>r("div",{class:[q(),t.className],onTouchstart:_,onTouchmove:E,onTouchend:p,onTouchcancel:p},[r("ul",{ref:k,style:{transform:`translate3d(0, ${a.offset+P()}px, 0)`,transitionDuration:`${a.duration}ms`,transitionProperty:a.duration?"all":"none"},class:q("wrapper"),onTransitionend:H},[$()])])}});const[Te,y,ie]=F("picker"),Ie={title:String,loading:Boolean,readonly:Boolean,allowHtml:Boolean,itemHeight:K(44),showToolbar:me,swipeDuration:K(1e3),visibleItemCount:K(6),cancelButtonText:String,confirmButtonText:String};var Pe=Z({name:Te,props:Q({},Ie,{valueKey:String,defaultIndex:K(0),toolbarPosition:ue("top"),columnsFieldNames:Object,columns:{type:Array,default:()=>[]}}),emits:["confirm","cancel","change"],setup(t,{emit:x,slots:l}){const d=ee([]),{text:I,values:b,children:u}=Q({text:t.valueKey||"text",values:"values",children:"children"},t.columnsFieldNames),{children:m,linkChildren:k}=xe(se);k();const a=te(()=>re(t.itemHeight)),f=te(()=>{const e=t.columns[0];if(typeof e=="object"){if(u in e)return"cascade";if(b in e)return"object"}return"plain"}),w=()=>{var i;const e=[];let o={[u]:t.columns};for(;o&&o[u];){const v=o[u];let T=(i=o.defaultIndex)!=null?i:+t.defaultIndex;for(;v[T]&&v[T].disabled;)if(T<v.length-1)T++;else{T=0;break}e.push({[b]:o[u],className:o.className,defaultIndex:T}),o=v[T]}d.value=e},P=()=>{const{columns:e}=t;f.value==="plain"?d.value=[{[b]:e}]:f.value==="cascade"?w():d.value=e},M=()=>m.map(e=>e.state.index),h=(e,o)=>{const i=m[e];i&&i.setOptions(o)},O=e=>{let o={[u]:t.columns};const i=M();for(let v=0;v<=e;v++)o=o[u][i[v]];for(;o&&o[u];)e++,h(e,o[u]),o=o[u][o.defaultIndex||0]},C=e=>m[e],N=e=>{const o=C(e);if(o)return o.getValue()},S=(e,o)=>{const i=C(e);i&&(i.setValue(o),f.value==="cascade"&&O(e))},D=e=>{const o=C(e);if(o)return o.state.index},H=(e,o)=>{const i=C(e);i&&(i.setIndex(o),f.value==="cascade"&&O(e))},_=e=>{const o=C(e);if(o)return o.state.options},E=()=>m.map(e=>e.getValue()),p=e=>{e.forEach((o,i)=>{S(i,o)})},$=e=>{e.forEach((o,i)=>{H(i,o)})},j=e=>{f.value==="plain"?x(e,N(0),D(0)):x(e,E(),M())},A=e=>{f.value==="cascade"&&O(e),f.value==="plain"?x("change",N(0),D(0)):x("change",E(),e)},n=()=>{m.forEach(e=>e.stopMomentum()),j("confirm")},s=()=>j("cancel"),c=()=>{if(l.title)return l.title();if(t.title)return r("div",{class:[y("title"),"van-ellipsis"]},[t.title])},g=()=>{const e=t.cancelButtonText||ie("cancel");return r("button",{type:"button",class:y("cancel"),onClick:s},[l.cancel?l.cancel():e])},V=()=>{const e=t.confirmButtonText||ie("confirm");return r("button",{type:"button",class:y("confirm"),onClick:n},[l.confirm?l.confirm():e])},B=()=>{if(t.showToolbar){const e=l.toolbar||l.default;return r("div",{class:y("toolbar")},[e?e():[g(),c(),V()]])}},L=()=>d.value.map((e,o)=>{var i;return r(Ce,{textKey:I,readonly:t.readonly,allowHtml:t.allowHtml,className:e.className,itemHeight:a.value,defaultIndex:(i=e.defaultIndex)!=null?i:+t.defaultIndex,swipeDuration:t.swipeDuration,initialOptions:e[b],visibleItemCount:t.visibleItemCount,onChange:()=>A(o)},{option:l.option})}),le=()=>{const e=a.value*+t.visibleItemCount,o={height:`${a.value}px`},i={height:`${e}px`},v={backgroundSize:`100% ${(e-a.value)/2}px`};return r("div",{class:y("columns"),style:i,onTouchmove:G},[L(),r("div",{class:y("mask"),style:v},null),r("div",{class:[fe,y("frame")],style:o},null)])};return Y(()=>t.columns,P,{immediate:!0}),W({confirm:n,getValues:E,setValues:p,getIndexes:M,setIndexes:$,getColumnIndex:D,setColumnIndex:H,getColumnValue:N,setColumnValue:S,getColumnValues:_,setColumnValues:h}),()=>{var e,o;return r("div",{class:y()},[t.toolbarPosition==="top"?B():null,t.loading?r(de,{class:y("loading")},null):null,(e=l["columns-top"])==null?void 0:e.call(l),le(),(o=l["columns-bottom"])==null?void 0:o.call(l),t.toolbarPosition==="bottom"?B():null])}}});export{Pe as _,Ie as p};
