import{c as e,u as t,d as n,p as o,z as l,e as a,A as s,t as i}from"./use-translate.91889477.js";import{c as r}from"./constant.4d85ecb9.js";import{u}from"./use-expose.5ea79906.js";import{L as c}from"./index.6e9dbec3.js";import{d}from"./deep-clone.8c2eaed3.js";import{u as m}from"./use-touch.30351383.js";import{z as f,D as p,E as v,x as g,e as h,C as x}from"./vue-libs.71fdcafc.js";import{u as b}from"./useParent.e4fd6deb.js";import{u as y}from"./useChildren.edf9a3d1.js";const[I,C]=e("picker-column");const N=Symbol(I),w=e=>n(e)&&e.disabled;var S=f({name:I,props:{readonly:Boolean,allowHtml:Boolean,className:t,textKey:{type:String,required:!0},itemHeight:{type:Number,required:!0},swipeDuration:{type:[Number,String],required:!0},visibleItemCount:{type:[Number,String],required:!0},defaultIndex:{type:Number,default:0},initialOptions:{type:Array,default:()=>[]}},emits:["change"],setup(e,{emit:t,slots:a}){let s,i,r,c,f;const x=p(),y=v({index:e.defaultIndex,offset:0,duration:0,options:d(e.initialOptions)}),I=m(),S=()=>y.options.length,H=()=>e.itemHeight*(+e.visibleItemCount-1)/2,T=(n,o)=>{const a=-(n=(e=>{for(let t=e=l(e,0,S());t<S();t++)if(!w(y.options[t]))return t;for(let t=e-1;t>=0;t--)if(!w(y.options[t]))return t})(n)||0)*e.itemHeight,i=()=>{n!==y.index&&(y.index=n,o&&t("change",n))};s&&a!==y.offset?f=i:i(),y.offset=a},j=t=>{JSON.stringify(t)!==JSON.stringify(y.options)&&(y.options=d(t),T(e.defaultIndex))},V=t=>n(t)&&e.textKey in t?t[e.textKey]:t,D=t=>l(Math.round(-t/e.itemHeight),0,S()-1),k=()=>{s=!1,y.duration=0,f&&(f(),f=null)},B=t=>{if(!e.readonly){if(I.start(t),s){const e=function(e){const{transform:t}=window.getComputedStyle(e),n=t.slice(7,t.length-1).split(", ")[5];return Number(n)}(x.value);y.offset=Math.min(0,e-H()),i=y.offset}else i=y.offset;y.duration=0,r=Date.now(),c=i,f=null}},O=t=>{if(e.readonly)return;I.move(t),I.isVertical()&&(s=!0,o(t,!0)),y.offset=l(i+I.deltaY.value,-S()*e.itemHeight,e.itemHeight);const n=Date.now();n-r>300&&(r=n,c=y.offset)},M=()=>{if(e.readonly)return;const t=y.offset-c,n=Date.now()-r;if(n<300&&Math.abs(t)>15)return void((t,n)=>{const o=Math.abs(t/n);t=y.offset+o/.003*(t<0?-1:1);const l=D(t);y.duration=+e.swipeDuration,T(l,!0)})(t,n);const o=D(y.offset);y.duration=200,T(o,!0),setTimeout((()=>{s=!1}),0)},K=()=>{const t={height:`${e.itemHeight}px`};return y.options.map(((n,o)=>{const l=V(n),i=w(n),r={role:"button",style:t,tabindex:i?-1:0,class:C("item",{disabled:i,selected:o===y.index}),onClick:()=>(t=>{s||e.readonly||(f=null,y.duration=200,T(t,!0))})(o)},u={class:"van-ellipsis",[e.allowHtml?"innerHTML":"textContent"]:l};return h("li",r,[a.option?a.option(n):h("div",u,null)])}))};return T(y.index),b(N),u({state:y,setIndex:T,getValue:()=>y.options[y.index],setValue:e=>{const{options:t}=y;for(let n=0;n<t.length;n++)if(V(t[n])===e)return T(n)},setOptions:j,stopMomentum:k}),g((()=>e.initialOptions),j),g((()=>e.defaultIndex),(e=>T(e))),()=>h("div",{class:[C(),e.className],onTouchstart:B,onTouchmove:O,onTouchend:M,onTouchcancel:M},[h("ul",{ref:x,style:{transform:`translate3d(0, ${y.offset+H()}px, 0)`,transitionDuration:`${y.duration}ms`,transitionProperty:y.duration?"all":"none"},class:C("wrapper"),onTransitionend:k},[K()])])}});const[H,T,j]=e("picker"),V={title:String,loading:Boolean,readonly:Boolean,allowHtml:Boolean,showToolbar:i,cancelButtonText:String,confirmButtonText:String,itemHeight:{type:[Number,String],default:44},visibleItemCount:{type:[Number,String],default:6},swipeDuration:{type:[Number,String],default:1e3}};var D=f({name:H,props:a({},V,{valueKey:String,columnsFieldNames:Object,columns:{type:Array,default:()=>[]},defaultIndex:{type:[Number,String],default:0},toolbarPosition:{type:String,default:"top"}}),emits:["confirm","cancel","change"],setup(e,{emit:t,slots:n}){const l=p([]),{text:i,values:d,children:m}=a({text:e.valueKey||"text",values:"values",children:"children"},e.columnsFieldNames),{children:f,linkChildren:v}=y(N);v();const b=x((()=>s(e.itemHeight))),I=x((()=>{const t=e.columns[0];if("object"==typeof t){if(m in t)return"cascade";if(d in t)return"object"}return"plain"})),C=()=>f.map((e=>e.state.index)),w=(e,t)=>{const n=f[e];n&&n.setOptions(t)},H=t=>{let n={[m]:e.columns};const o=C();for(let e=0;e<=t;e++)n=n[m][o[e]];for(;n&&n[m];)t++,w(t,n[m]),n=n[m][n.defaultIndex||0]},V=e=>f[e],D=e=>{const t=V(e);if(t)return t.getValue()},k=(e,t)=>{const n=V(e);n&&(n.setValue(t),"cascade"===I.value&&H(e))},B=e=>{const t=V(e);if(t)return t.state.index},O=(e,t)=>{const n=V(e);n&&(n.setIndex(t),"cascade"===I.value&&H(e))},M=()=>f.map((e=>e.getValue())),K=e=>{"plain"===I.value?t(e,D(0),B(0)):t(e,M(),C())},$=()=>{f.forEach((e=>e.stopMomentum())),K("confirm")},P=()=>K("cancel"),q=()=>{const t=e.cancelButtonText||j("cancel");return h("button",{type:"button",class:T("cancel"),onClick:P},[n.cancel?n.cancel():t])},E=()=>{const t=e.confirmButtonText||j("confirm");return h("button",{type:"button",class:T("confirm"),onClick:$},[n.confirm?n.confirm():t])},z=()=>{if(e.showToolbar){const t=n.toolbar||n.default;return h("div",{class:T("toolbar")},[t?t():[q(),n.title?n.title():e.title?h("div",{class:[T("title"),"van-ellipsis"]},[e.title]):void 0,E()]])}},A=()=>l.value.map(((o,l)=>{var a;return h(S,{textKey:i,readonly:e.readonly,allowHtml:e.allowHtml,className:o.className,itemHeight:b.value,defaultIndex:null!=(a=o.defaultIndex)?a:+e.defaultIndex,swipeDuration:e.swipeDuration,initialOptions:o[d],visibleItemCount:e.visibleItemCount,onChange:()=>(e=>{"cascade"===I.value&&H(e),"plain"===I.value?t("change",D(0),B(0)):t("change",M(),e)})(l)},{option:n.option})})),F=()=>{const t=b.value*+e.visibleItemCount,n={height:`${b.value}px`},l={height:`${t}px`},a={backgroundSize:`100% ${(t-b.value)/2}px`};return h("div",{class:T("columns"),style:l,onTouchmove:o},[A(),h("div",{class:T("mask"),style:a},null),h("div",{class:[r,T("frame")],style:n},null)])};return g((()=>e.columns),(()=>{const{columns:t}=e;"plain"===I.value?l.value=[{[d]:t}]:"cascade"===I.value?(()=>{var t;const n=[];let o={[m]:e.columns};for(;o&&o[m];){const l=o[m];let a=null!=(t=o.defaultIndex)?t:+e.defaultIndex;for(;l[a]&&l[a].disabled;){if(!(a<l.length-1)){a=0;break}a++}n.push({[d]:o[m],className:o.className,defaultIndex:a}),o=l[a]}l.value=n})():l.value=t}),{immediate:!0}),u({confirm:$,getValues:M,setValues:e=>{e.forEach(((e,t)=>{k(t,e)}))},getIndexes:C,setIndexes:e=>{e.forEach(((e,t)=>{O(t,e)}))},getColumnIndex:B,setColumnIndex:O,getColumnValue:D,setColumnValue:k,getColumnValues:e=>{const t=V(e);if(t)return t.state.options},setColumnValues:w}),()=>{var t,o;return h("div",{class:T()},["top"===e.toolbarPosition?z():null,e.loading?h(c,{class:T("loading")},null):null,null==(t=n["columns-top"])?void 0:t.call(n),F(),null==(o=n["columns-bottom"])?void 0:o.call(n),"bottom"===e.toolbarPosition?z():null])}}});export{D as _,V as p};
