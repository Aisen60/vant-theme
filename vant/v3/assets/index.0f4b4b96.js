import{c as e,r as t,j as a,i,e as l,t as r,l as n,o}from"./use-translate.91889477.js";import{w as s}from"./with-install.c9eedd0e.js";import{u as d}from"./use-expose.5ea79906.js";import{I as c}from"./index.d38d9435.js";import{I as u}from"./function-call.c3deb159.js";import{c as p}from"./interceptor.fd551ac3.js";import{I as m}from"./index.9ee79ebb.js";import{L as f}from"./index.6e9dbec3.js";import{z as v,e as g,A as b,D as w,I as y,E as x}from"./vue-libs.71fdcafc.js";import{u as h}from"./index.a16d08bc.js";const[S,z]=e("uploader"),j=e=>Array.isArray(e)?e:[e];function A(e,t){return new Promise((a=>{if("file"===t)return void a();const i=new FileReader;i.onload=e=>{a(e.target.result)},"dataUrl"===t?i.readAsDataURL(e):"text"===t&&i.readAsText(e)}))}function V(e,a){return j(e).some((e=>!!e.file&&(t(a)?a(e.file):e.file.size>a)))}const k=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i;function F(e){return!!e.isImage||(e.file&&e.file.type?0===e.file.type.indexOf("image"):e.url?(t=e.url,k.test(t)):"string"==typeof e.content&&0===e.content.indexOf("data:image"));var t}var I=v({props:{name:[Number,String],index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:[Number,String],beforeDelete:Function,item:{type:Object,required:!0}},emits:["delete","preview"],setup(e,{emit:t,slots:r}){const n=()=>{const{status:t,message:a}=e.item;if("uploading"===t||"failed"===t){const e="failed"===t?g(c,{name:"close",class:z("mask-icon")},null):g(f,{class:z("loading")},null),l=i(a)&&""!==a;return g("div",{class:z("mask")},[e,l&&g("div",{class:z("mask-message")},[a])])}},o=a=>{const{name:i,item:l,index:r,beforeDelete:n}=e;a.stopPropagation(),p({interceptor:n,args:[l,{name:i,index:r}],done:()=>t("delete")})},s=()=>t("preview"),d=()=>{if(e.deletable&&"uploading"!==e.item.status)return g("div",{class:z("preview-delete"),onClick:o},[g(c,{name:"cross",class:z("preview-delete-icon")},null)])},u=()=>{if(r["preview-cover"]){const{index:t,item:a}=e;return g("div",{class:z("preview-cover")},[r["preview-cover"](l({index:t},a))])}},v=()=>{const{item:t}=e;if(F(t)){let a;return g(m,{fit:e.imageFit,src:t.content||t.url,class:z("preview-image"),width:e.previewSize,height:e.previewSize,lazyLoad:e.lazyLoad,onClick:s},"function"==typeof(i=a=u())||"[object Object]"===Object.prototype.toString.call(i)&&!b(i)?a:{default:()=>[a]})}var i;return g("div",{class:z("file"),style:a(e.previewSize)},[g(c,{class:z("file-icon"),name:"description"},null),g("div",{class:[z("file-name"),"van-ellipsis"]},[t.file?t.file.name:t.url]),u()])};return()=>g("div",{class:z("preview")},[v(),n(),d()])}});const C=s(v({name:S,props:{capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,uploadText:String,deletable:r,afterRead:Function,showUpload:r,beforeRead:Function,beforeDelete:Function,previewSize:[Number,String],previewImage:r,previewOptions:Object,previewFullImage:r,name:{type:[Number,String],default:""},accept:{type:String,default:"image/*"},modelValue:{type:Array,default:()=>[]},maxSize:{type:[Number,String,Function],default:Number.MAX_VALUE},maxCount:{type:[Number,String],default:Number.MAX_VALUE},imageFit:{type:String,default:"cover"},resultType:{type:String,default:"dataUrl"},uploadIcon:{type:String,default:"photograph"}},emits:["delete","oversize","click-upload","close-preview","click-preview","update:modelValue"],setup(e,{emit:t,slots:i}){const r=w(),s=(t=e.modelValue.length)=>({name:e.name,index:t}),p=()=>{r.value&&(r.value.value="")},m=a=>{if(p(),V(a,e.maxSize)){if(!Array.isArray(a))return void t("oversize",a,s());{const i=function(e,t){const a=[],i=[];return e.forEach((e=>{V(e,t)?i.push(e):a.push(e)})),{valid:a,invalid:i}}(a,e.maxSize);if(a=i.valid,t("oversize",i.invalid,s()),!a.length)return}}a=x(a),t("update:modelValue",[...e.modelValue,...j(a)]),e.afterRead&&e.afterRead(a,s())},f=t=>{const{maxCount:a,modelValue:i,resultType:l}=e;if(Array.isArray(t)){const e=+a-i.length;t.length>e&&(t=t.slice(0,e)),Promise.all(t.map((e=>A(e,l)))).then((e=>{const a=t.map(((t,a)=>{const i={file:t,status:"",message:""};return e[a]&&(i.content=e[a]),i}));m(a)}))}else A(t,l).then((e=>{const a={file:t,status:"",message:""};e&&(a.content=e),m(a)}))},v=t=>{const{files:a}=t.target;if(e.disabled||!a||!a.length)return;const i=1===a.length?a[0]:[].slice.call(a);if(e.beforeRead){const t=e.beforeRead(i,s());if(!t)return void p();if(n(t))return void t.then((e=>{f(e||i)})).catch(p)}f(i)};let b;const S=()=>t("close-preview"),k=(a,r)=>{const n=["imageFit","deletable","previewSize","beforeDelete"],d=l(o(e,n),o(a,n,!0));return g(I,y({item:a,index:r,onClick:()=>t("click-preview",a,s(r)),onDelete:()=>((a,i)=>{const l=e.modelValue.slice(0);l.splice(i,1),t("update:modelValue",l),t("delete",a,s(i))})(a,r),onPreview:()=>(t=>{if(e.previewFullImage){const a=e.modelValue.filter(F),i=a.map((e=>e.content||e.url)).filter(Boolean);b=u(l({images:i,startPosition:a.indexOf(t),onClose:S},e.previewOptions))}})(a)},o(e,["name","lazyLoad"]),d),{"preview-cover":i["preview-cover"]})},C=()=>{if(e.previewImage)return e.modelValue.map(k)},L=e=>t("click-upload",e),N=()=>{if(e.modelValue.length>=e.maxCount||!e.showUpload)return;const t=e.readonly?null:g("input",{ref:r,type:"file",class:z("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:v},null);return i.default?g("div",{class:z("input-wrapper"),onClick:L},[i.default(),t]):g("div",{class:z("upload",{readonly:e.readonly}),style:a(e.previewSize),onClick:L},[g(c,{name:e.uploadIcon,class:z("upload-icon")},null),e.uploadText&&g("span",{class:z("upload-text")},[e.uploadText]),t])};return d({chooseFile:()=>{r.value&&!e.disabled&&r.value.click()},closeImagePreview:()=>{b&&b.close()}}),h((()=>e.modelValue)),()=>g("div",{class:z()},[g("div",{class:z("wrapper",{disabled:e.disabled})},[C(),N()])])}}));export{C as U};
