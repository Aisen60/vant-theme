import{c as J,u as fe,f as q,l as G,D as U,e as Q,b as de,E as he}from"./use-translate.a3af5295.js";import{d as K,u as ge,a as ve,n as W,b as X,c as _,m as be,t as xe}from"./with-install.1b1f1c54.js";import{H as Z,a as Ce}from"./constant.80c6de18.js";import{u as ee}from"./use-expose.b6cf8b20.js";import{L as Te}from"./index.31456700.js";import{d as te}from"./deep-clone.46a1ff2d.js";import{u as ye}from"./use-touch.21117490.js";import{z as ne,D as oe,H as Ie,x as Y,e as r,C as ae}from"./vue-libs.6d5ed635.js";const se=200,ie=300,we=15,[le,F]=J("picker-column");function Oe(t){const{transform:x}=window.getComputedStyle(t),l=x.slice(7,x.length-1).split(", ")[5];return Number(l)}const ce=Symbol(le),z=t=>q(t)&&t.disabled;var ke=ne({name:le,props:{textKey:K(String),readonly:Boolean,allowHtml:Boolean,className:ge,itemHeight:K(Number),defaultIndex:ve(0),swipeDuration:K(W),initialOptions:X(),visibleItemCount:K(W)},emits:["change"],setup(t,{emit:x,slots:l}){let m,I,h,u,f;const D=oe(),a=Ie({index:t.defaultIndex,offset:0,duration:0,options:te(t.initialOptions)}),d=ye(),w=()=>a.options.length,E=()=>t.itemHeight*(+t.visibleItemCount-1)/2,H=n=>{n=U(n,0,w());for(let s=n;s<w();s++)if(!z(a.options[s]))return s;for(let s=n-1;s>=0;s--)if(!z(a.options[s]))return s},g=(n,s)=>{n=H(n)||0;const c=-n*t.itemHeight,v=()=>{n!==a.index&&(a.index=n,s&&x("change",n))};m&&c!==a.offset?f=v:v(),a.offset=c},O=n=>{JSON.stringify(n)!==JSON.stringify(a.options)&&(a.options=te(n),g(t.defaultIndex))},T=n=>{m||t.readonly||(f=null,a.duration=se,g(n,!0))},k=n=>q(n)&&t.textKey in n?n[t.textKey]:n,M=n=>U(Math.round(-n/t.itemHeight),0,w()-1),N=(n,s)=>{const c=Math.abs(n/s);n=a.offset+c/.003*(n<0?-1:1);const v=M(n);a.duration=+t.swipeDuration,g(v,!0)},S=()=>{m=!1,a.duration=0,f&&(f(),f=null)},$=n=>{if(!t.readonly){if(d.start(n),m){const s=Oe(D.value);a.offset=Math.min(0,s-E()),I=a.offset}else I=a.offset;a.duration=0,h=Date.now(),u=I,f=null}},P=n=>{if(t.readonly)return;d.move(n),d.isVertical()&&(m=!0,G(n,!0)),a.offset=U(I+d.deltaY.value,-(w()*t.itemHeight),t.itemHeight);const s=Date.now();s-h>ie&&(h=s,u=a.offset)},j=()=>{if(t.readonly)return;const n=a.offset-u,s=Date.now()-h;if(s<ie&&Math.abs(n)>we){N(n,s);return}const v=M(a.offset);a.duration=se,g(v,!0),setTimeout(()=>{m=!1},0)},A=()=>{const n={height:`${t.itemHeight}px`};return a.options.map((s,c)=>{const v=k(s),B=z(s),V={role:"button",style:n,tabindex:B?-1:0,class:F("item",{disabled:B,selected:c===a.index}),onClick:()=>T(c)},R={class:"van-ellipsis",[t.allowHtml?"innerHTML":"textContent"]:v};return r("li",V,[l.option?l.option(s):r("div",R,null)])})},p=n=>{const{options:s}=a;for(let c=0;c<s.length;c++)if(k(s[c])===n)return g(c)},L=()=>a.options[a.index];return g(a.index),fe(ce),ee({state:a,setIndex:g,getValue:L,setValue:p,setOptions:O,stopMomentum:S}),Y(()=>t.initialOptions,O),Y(()=>t.defaultIndex,n=>g(n)),()=>r("div",{class:[F(),t.className],onTouchstart:$,onTouchmove:P,onTouchend:j,onTouchcancel:j},[r("ul",{ref:D,style:{transform:`translate3d(0, ${a.offset+E()}px, 0)`,transitionDuration:`${a.duration}ms`,transitionProperty:a.duration?"all":"none"},class:F("wrapper"),onTransitionend:S},[A()])])}});const[He,C,ue]=J("picker"),Me={title:String,loading:Boolean,readonly:Boolean,allowHtml:Boolean,itemHeight:_(44),showToolbar:xe,swipeDuration:_(1e3),visibleItemCount:_(6),cancelButtonText:String,confirmButtonText:String},Ne=Q({},Me,{columns:X(),valueKey:String,defaultIndex:_(0),toolbarPosition:be("top"),columnsFieldNames:Object});var Ke=ne({name:He,props:Ne,emits:["confirm","cancel","change"],setup(t,{emit:x,slots:l}){const m=oe([]),{text:I,values:h,children:u}=Q({text:t.valueKey||"text",values:"values",children:"children"},t.columnsFieldNames),{children:f,linkChildren:D}=de(ce);D();const a=ae(()=>he(t.itemHeight)),d=ae(()=>{const e=t.columns[0];if(typeof e=="object"){if(u in e)return"cascade";if(h in e)return"object"}return"plain"}),w=()=>{var i;const e=[];let o={[u]:t.columns};for(;o&&o[u];){const b=o[u];let y=(i=o.defaultIndex)!=null?i:+t.defaultIndex;for(;b[y]&&b[y].disabled;)if(y<b.length-1)y++;else{y=0;break}e.push({[h]:o[u],className:o.className,defaultIndex:y}),o=b[y]}m.value=e},E=()=>{const{columns:e}=t;d.value==="plain"?m.value=[{[h]:e}]:d.value==="cascade"?w():m.value=e},H=()=>f.map(e=>e.state.index),g=(e,o)=>{const i=f[e];i&&i.setOptions(o)},O=e=>{let o={[u]:t.columns};const i=H();for(let b=0;b<=e;b++)o=o[u][i[b]];for(;o&&o[u];)e++,g(e,o[u]),o=o[u][o.defaultIndex||0]},T=e=>f[e],k=e=>{const o=T(e);if(o)return o.getValue()},M=(e,o)=>{const i=T(e);i&&(i.setValue(o),d.value==="cascade"&&O(e))},N=e=>{const o=T(e);if(o)return o.state.index},S=(e,o)=>{const i=T(e);i&&(i.setIndex(o),d.value==="cascade"&&O(e))},$=e=>{const o=T(e);if(o)return o.state.options},P=()=>f.map(e=>e.getValue()),j=e=>{e.forEach((o,i)=>{M(i,o)})},A=e=>{e.forEach((o,i)=>{S(i,o)})},p=e=>{d.value==="plain"?x(e,k(0),N(0)):x(e,P(),H())},L=e=>{d.value==="cascade"&&O(e),d.value==="plain"?x("change",k(0),N(0)):x("change",P(),e)},n=()=>{f.forEach(e=>e.stopMomentum()),p("confirm")},s=()=>p("cancel"),c=()=>{if(l.title)return l.title();if(t.title)return r("div",{class:[C("title"),"van-ellipsis"]},[t.title])},v=()=>{const e=t.cancelButtonText||ue("cancel");return r("button",{type:"button",class:[C("cancel"),Z],onClick:s},[l.cancel?l.cancel():e])},B=()=>{const e=t.confirmButtonText||ue("confirm");return r("button",{type:"button",class:[C("confirm"),Z],onClick:n},[l.confirm?l.confirm():e])},V=()=>{if(t.showToolbar){const e=l.toolbar||l.default;return r("div",{class:C("toolbar")},[e?e():[v(),c(),B()]])}},R=()=>m.value.map((e,o)=>{var i;return r(ke,{textKey:I,readonly:t.readonly,allowHtml:t.allowHtml,className:e.className,itemHeight:a.value,defaultIndex:(i=e.defaultIndex)!=null?i:+t.defaultIndex,swipeDuration:t.swipeDuration,initialOptions:e[h],visibleItemCount:t.visibleItemCount,onChange:()=>L(o)},{option:l.option})}),re=e=>{if(m.value.some(i=>i[h]&&i[h].length!==0)){const i={height:`${a.value}px`},b={backgroundSize:`100% ${(e-a.value)/2}px`};return[r("div",{class:C("mask"),style:b},null),r("div",{class:[Ce,C("frame")],style:i},null)]}},me=()=>{const e=a.value*+t.visibleItemCount,o={height:`${e}px`};return r("div",{class:C("columns"),style:o,onTouchmove:G},[R(),re(e)])};return Y(()=>t.columns,E,{immediate:!0}),ee({confirm:n,getValues:P,setValues:j,getIndexes:H,setIndexes:A,getColumnIndex:N,setColumnIndex:S,getColumnValue:k,setColumnValue:M,getColumnValues:$,setColumnValues:g}),()=>{var e,o;return r("div",{class:C()},[t.toolbarPosition==="top"?V():null,t.loading?r(Te,{class:C("loading")},null):null,(e=l["columns-top"])==null?void 0:e.call(l),me(),(o=l["columns-bottom"])==null?void 0:o.call(l),t.toolbarPosition==="bottom"?V():null])}}});export{Ke as _,Me as p};
