import{c as q,w as _,q as A,i as Q,e as x,B as X,r as H,p as z}from"./use-translate.aef3085b.js";import{n as C,d as J,c as D,m as I,t as y,b as K,w as W}from"./with-install.796b4cad.js";import{u as Y}from"./use-expose.b82056d2.js";import{I as P}from"./index.c480cbe8.js";import{I as Z}from"./function-call.07b90c69.js";import{c as $}from"./interceptor.3dc21389.js";import{I as ee}from"./index.67230d2f.js";import{L as ae}from"./index.88eab4b6.js";import{z as R,e as l,C as ne,Q as te,G as le}from"./vue-libs.f710b8ed.js";const[ie,i]=q("uploader"),U=e=>Array.isArray(e)?e:[e];function L(e,n){return new Promise(o=>{if(n==="file"){o();return}const s=new FileReader;s.onload=c=>{o(c.target.result)},n==="dataUrl"?s.readAsDataURL(e):n==="text"&&s.readAsText(e)})}function B(e,n){return U(e).some(o=>o.file?_(n)?n(o.file):o.file.size>n:!1)}function re(e,n){const o=[],s=[];return e.forEach(c=>{B(c,n)?s.push(c):o.push(c)}),{valid:o,invalid:s}}const oe=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i,se=e=>oe.test(e);function O(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?se(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ce=R({props:{name:C,item:J(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:C,beforeDelete:Function},emits:["delete","preview"],setup(e,{emit:n,slots:o}){const s=()=>{const{status:r,message:f}=e.item;if(r==="uploading"||r==="failed"){const p=r==="failed"?l(P,{name:"close",class:i("mask-icon")},null):l(ae,{class:i("loading")},null),b=Q(f)&&f!=="";return l("div",{class:i("mask")},[p,b&&l("div",{class:i("mask-message")},[f])])}},c=r=>{const{name:f,item:p,index:b,beforeDelete:F}=e;r.stopPropagation(),$(F,{args:[p,{name:f,index:b}],done:()=>n("delete")})},w=()=>n("preview"),h=()=>{if(e.deletable&&e.item.status!=="uploading")return l("div",{class:i("preview-delete"),onClick:c},[l(P,{name:"cross",class:i("preview-delete-icon")},null)])},g=()=>{if(o["preview-cover"]){const{index:r,item:f}=e;return l("div",{class:i("preview-cover")},[o["preview-cover"](x({index:r},f))])}},k=()=>{const{item:r}=e;return O(r)?l(ee,{fit:e.imageFit,src:r.content||r.url,class:i("preview-image"),width:e.previewSize,height:e.previewSize,lazyLoad:e.lazyLoad,onClick:w},{default:g}):l("div",{class:i("file"),style:A(e.previewSize)},[l(P,{class:i("file-icon"),name:"description"},null),l("div",{class:[i("file-name"),"van-ellipsis"]},[r.file?r.file.name:r.url]),g()])};return()=>l("div",{class:i("preview")},[k(),s(),h()])}});const de={name:D(""),accept:I("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:D(1/0),imageFit:I("cover"),resultType:I("dataUrl"),uploadIcon:I("photograph"),uploadText:String,deletable:y,afterRead:Function,showUpload:y,modelValue:K(),beforeRead:Function,beforeDelete:Function,previewSize:C,previewImage:y,previewOptions:Object,previewFullImage:y,maxSize:{type:[Number,String,Function],default:1/0}};var ue=R({name:ie,props:de,emits:["delete","oversize","click-upload","close-preview","click-preview","update:modelValue"],setup(e,{emit:n,slots:o}){const s=ne(),c=(a=e.modelValue.length)=>({name:e.name,index:a}),w=()=>{s.value&&(s.value.value="")},h=a=>{if(w(),B(a,e.maxSize))if(Array.isArray(a)){const t=re(a,e.maxSize);if(a=t.valid,n("oversize",t.invalid,c()),!a.length)return}else{n("oversize",a,c());return}a=le(a),n("update:modelValue",[...e.modelValue,...U(a)]),e.afterRead&&e.afterRead(a,c())},g=a=>{const{maxCount:t,modelValue:d,resultType:u}=e;if(Array.isArray(a)){const m=+t-d.length;a.length>m&&(a=a.slice(0,m)),Promise.all(a.map(v=>L(v,u))).then(v=>{const T=a.map((G,j)=>{const V={file:G,status:"",message:""};return v[j]&&(V.content=v[j]),V});h(T)})}else L(a,u).then(m=>{const v={file:a,status:"",message:""};m&&(v.content=m),h(v)})},k=a=>{const{files:t}=a.target;if(e.disabled||!t||!t.length)return;const d=t.length===1?t[0]:[].slice.call(t);if(e.beforeRead){const u=e.beforeRead(d,c());if(!u){w();return}if(H(u)){u.then(m=>{g(m||d)}).catch(w);return}}g(d)};let r;const f=()=>n("close-preview"),p=a=>{if(e.previewFullImage){const t=e.modelValue.filter(O),d=t.map(u=>u.content||u.url).filter(Boolean);r=Z(x({images:d,startPosition:t.indexOf(a),onClose:f},e.previewOptions))}},b=()=>{r&&r.close()},F=(a,t)=>{const d=e.modelValue.slice(0);d.splice(t,1),n("update:modelValue",d),n("delete",a,c(t))},E=(a,t)=>{const d=["imageFit","deletable","previewSize","beforeDelete"],u=x(z(e,d),z(a,d,!0));return l(ce,te({item:a,index:t,onClick:()=>n("click-preview",a,c(t)),onDelete:()=>F(a,t),onPreview:()=>p(a)},z(e,["name","lazyLoad"]),u),{"preview-cover":o["preview-cover"]})},N=()=>{if(e.previewImage)return e.modelValue.map(E)},S=a=>n("click-upload",a),M=()=>{if(e.modelValue.length>=e.maxCount||!e.showUpload)return;const a=e.readonly?null:l("input",{ref:s,type:"file",class:i("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:k},null);return o.default?l("div",{class:i("input-wrapper"),onClick:S},[o.default(),a]):l("div",{class:i("upload",{readonly:e.readonly}),style:A(e.previewSize),onClick:S},[l(P,{name:e.uploadIcon,class:i("upload-icon")},null),e.uploadText&&l("span",{class:i("upload-text")},[e.uploadText]),a])};return Y({chooseFile:()=>{s.value&&!e.disabled&&s.value.click()},closeImagePreview:b}),X(()=>e.modelValue),()=>l("div",{class:i()},[l("div",{class:i("wrapper",{disabled:e.disabled})},[N(),M()])])}});const Pe=W(ue);export{Pe as U};
