import{m as e,i as t,e as i,t as a,j as l,p as r}from"./use-translate.b583725c.js";import{c as n,w as o}from"./with-install.62f47d2f.js";import{g as s}from"./unit.49c29796.js";import{u as d}from"./use-expose.33de0944.js";import{I as c}from"./index.3af24151.js";import{I as u}from"./function-call.df6d8027.js";import{c as p}from"./interceptor.ab1192d4.js";import{I as m}from"./index.620c085b.js";import{L as f}from"./index.6fa13143.js";import{A as v,e as g,B as w,E as b,J as y,G as x}from"./vendor.ef334a89.js";import{u as h}from"./index.49199c0d.js";const[S,j]=n("uploader");function z(e){return Array.isArray(e)?e:[e]}function A(e,t){return new Promise((i=>{if("file"===t)return void i();const a=new FileReader;a.onload=e=>{i(e.target.result)},"dataUrl"===t?a.readAsDataURL(e):"text"===t&&a.readAsText(e)}))}function V(t,i){return z(t).some((t=>!!t.file&&(e(i)?i(t.file):t.file.size>i)))}const k=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i;function F(e){return!!e.isImage||(e.file&&e.file.type?0===e.file.type.indexOf("image"):e.url?(t=e.url,k.test(t)):"string"==typeof e.content&&0===e.content.indexOf("data:image"));var t}var I=v({props:{name:[Number,String],index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:[Number,String],beforeDelete:Function,item:{type:Object,required:!0}},emits:["delete","preview"],setup(e,{emit:a,slots:l}){const r=()=>{const{status:i,message:a}=e.item;if("uploading"===i||"failed"===i){const e="failed"===i?g(c,{name:"close",class:j("mask-icon")},null):g(f,{class:j("loading")},null),l=t(a)&&""!==a;return g("div",{class:j("mask")},[e,l&&g("div",{class:j("mask-message")},[a])])}},n=t=>{const{name:i,item:l,index:r,beforeDelete:n}=e;t.stopPropagation(),p({interceptor:n,args:[l,{name:i,index:r}],done:()=>a("delete")})},o=()=>a("preview"),d=()=>{if(e.deletable&&"uploading"!==e.item.status)return g("div",{class:j("preview-delete"),onClick:n},[g(c,{name:"cross",class:j("preview-delete-icon")},null)])},u=()=>{if(l["preview-cover"]){const{index:t,item:a}=e;return g("div",{class:j("preview-cover")},[l["preview-cover"](i({index:t},a))])}},v=()=>{const{item:t}=e;if(F(t)){let a;return g(m,{fit:e.imageFit,src:t.content||t.url,class:j("preview-image"),width:e.previewSize,height:e.previewSize,lazyLoad:e.lazyLoad,onClick:o},"function"==typeof(i=a=u())||"[object Object]"===Object.prototype.toString.call(i)&&!w(i)?a:{default:()=>[a]})}var i;return g("div",{class:j("file"),style:s(e.previewSize)},[g(c,{class:j("file-icon"),name:"description"},null),g("div",{class:[j("file-name"),"van-ellipsis"]},[t.file?t.file.name:t.url]),u()])};return()=>g("div",{class:j("preview")},[v(),r(),d()])}});const C=o(v({name:S,props:{capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,uploadText:String,deletable:a,afterRead:Function,showUpload:a,beforeRead:Function,beforeDelete:Function,previewSize:[Number,String],previewImage:a,previewOptions:Object,previewFullImage:a,name:{type:[Number,String],default:""},accept:{type:String,default:"image/*"},modelValue:{type:Array,default:()=>[]},maxSize:{type:[Number,String,Function],default:Number.MAX_VALUE},maxCount:{type:[Number,String],default:Number.MAX_VALUE},imageFit:{type:String,default:"cover"},resultType:{type:String,default:"dataUrl"},uploadIcon:{type:String,default:"photograph"}},emits:["delete","oversize","click-upload","close-preview","click-preview","update:modelValue"],setup(e,{emit:t,slots:a}){const n=b(),o=(t=e.modelValue.length)=>({name:e.name,index:t}),p=()=>{n.value&&(n.value.value="")},m=i=>{if(p(),V(i,e.maxSize)){if(!Array.isArray(i))return void t("oversize",i,o());{const a=function(e,t){const i=[],a=[];return e.forEach((e=>{V(e,t)?a.push(e):i.push(e)})),{valid:i,invalid:a}}(i,e.maxSize);if(i=a.valid,t("oversize",a.invalid,o()),!i.length)return}}i=x(i),t("update:modelValue",[...e.modelValue,...z(i)]),e.afterRead&&e.afterRead(i,o())},f=t=>{const{maxCount:i,modelValue:a,resultType:l}=e;if(Array.isArray(t)){const e=+i-a.length;t.length>e&&(t=t.slice(0,e)),Promise.all(t.map((e=>A(e,l)))).then((e=>{const i=t.map(((t,i)=>{const a={file:t,status:"",message:""};return e[i]&&(a.content=e[i]),a}));m(i)}))}else A(t,l).then((e=>{const i={file:t,status:"",message:""};e&&(i.content=e),m(i)}))},v=t=>{const{files:i}=t.target;if(e.disabled||!i||!i.length)return;const a=1===i.length?i[0]:[].slice.call(i);if(e.beforeRead){const t=e.beforeRead(a,o());if(!t)return void p();if(l(t))return void t.then((e=>{f(e||a)})).catch(p)}f(a)};let w;const S=()=>t("close-preview"),k=(l,n)=>{const s=["imageFit","deletable","previewSize","beforeDelete"],d=i(r(e,s),r(l,s,!0));return g(I,y({item:l,index:n,onClick:()=>t("click-preview",l,o(n)),onDelete:()=>((i,a)=>{const l=e.modelValue.slice(0);l.splice(a,1),t("update:modelValue",l),t("delete",i,o(a))})(l,n),onPreview:()=>(t=>{if(e.previewFullImage){const a=e.modelValue.filter(F),l=a.map((e=>e.content||e.url)).filter(Boolean);w=u(i({images:l,startPosition:a.indexOf(t),onClose:S},e.previewOptions))}})(l)},r(e,["name","lazyLoad"]),d),{"preview-cover":a["preview-cover"]})},C=()=>{if(e.previewImage)return e.modelValue.map(k)},L=e=>t("click-upload",e),N=()=>{if(e.modelValue.length>=e.maxCount||!e.showUpload)return;const t=e.readonly?null:g("input",{ref:n,type:"file",class:j("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:v},null);return a.default?g("div",{class:j("input-wrapper"),onClick:L},[a.default(),t]):g("div",{class:j("upload",{readonly:e.readonly}),style:s(e.previewSize),onClick:L},[g(c,{name:e.uploadIcon,class:j("upload-icon")},null),e.uploadText&&g("span",{class:j("upload-text")},[e.uploadText]),t])};return d({chooseFile:()=>{n.value&&!e.disabled&&n.value.click()},closeImagePreview:()=>{w&&w.close()}}),h((()=>e.modelValue)),()=>g("div",{class:j()},[g("div",{class:j("wrapper",{disabled:e.disabled})},[C(),N()])])}}));export{C as U};
