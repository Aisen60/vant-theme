import{c as G,w as q,n as k,j as A,i as X,e as z,s as D,m as h,t as I,l as H,r as j}from"./use-translate.e667ce10.js";import{w as J}from"./with-install.feb19484.js";import{u as K}from"./use-expose.9b0dd301.js";import{I as F}from"./index.472ff4df.js";import{I as Q}from"./function-call.de02bd03.js";import{c as W}from"./interceptor.b759bdc5.js";import{I as Y}from"./index.b7f6e1af.js";import{L as Z}from"./index.ae867a8e.js";import{z as U,e as i,A as $,D as ee,I as ae,E as te}from"./vue-libs.1dda7261.js";import{u as ne}from"./index.5b10c1d9.js";const[ie,l]=G("uploader"),L=e=>Array.isArray(e)?e:[e];function R(e,t){return new Promise(o=>{if(t==="file"){o();return}const s=new FileReader;s.onload=c=>{o(c.target.result)},t==="dataUrl"?s.readAsDataURL(e):t==="text"&&s.readAsText(e)})}function O(e,t){return L(e).some(o=>o.file?q(t)?t(o.file):o.file.size>t:!1)}function le(e,t){const o=[],s=[];return e.forEach(c=>{O(c,t)?s.push(c):o.push(c)}),{valid:o,invalid:s}}const re=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i,oe=e=>re.test(e);function B(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?oe(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}function se(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!$(e)}var ce=U({props:{name:k,index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:k,beforeDelete:Function,item:{type:Object,required:!0}},emits:["delete","preview"],setup(e,{emit:t,slots:o}){const s=()=>{const{status:r,message:d}=e.item;if(r==="uploading"||r==="failed"){const p=r==="failed"?i(F,{name:"close",class:l("mask-icon")},null):i(Z,{class:l("loading")},null),b=X(d)&&d!=="";return i("div",{class:l("mask")},[p,b&&i("div",{class:l("mask-message")},[d])])}},c=r=>{const{name:d,item:p,index:b,beforeDelete:x}=e;r.stopPropagation(),W({interceptor:x,args:[p,{name:d,index:b}],done:()=>t("delete")})},w=()=>t("preview"),y=()=>{if(e.deletable&&e.item.status!=="uploading")return i("div",{class:l("preview-delete"),onClick:c},[i(F,{name:"cross",class:l("preview-delete-icon")},null)])},g=()=>{if(o["preview-cover"]){const{index:r,item:d}=e;return i("div",{class:l("preview-cover")},[o["preview-cover"](z({index:r},d))])}},P=()=>{const{item:r}=e;if(B(r)){let d;return i(Y,{fit:e.imageFit,src:r.content||r.url,class:l("preview-image"),width:e.previewSize,height:e.previewSize,lazyLoad:e.lazyLoad,onClick:w},se(d=g())?d:{default:()=>[d]})}return i("div",{class:l("file"),style:A(e.previewSize)},[i(F,{class:l("file-icon"),name:"description"},null),i("div",{class:[l("file-name"),"van-ellipsis"]},[r.file?r.file.name:r.url]),g()])};return()=>i("div",{class:l("preview")},[P(),s(),y()])}});const de={name:D(""),accept:h("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:D(1/0),imageFit:h("cover"),resultType:h("dataUrl"),uploadIcon:h("photograph"),uploadText:String,deletable:I,afterRead:Function,showUpload:I,beforeRead:Function,beforeDelete:Function,previewSize:k,previewImage:I,previewOptions:Object,previewFullImage:I,modelValue:{type:Array,default:()=>[]},maxSize:{type:[Number,String,Function],default:1/0}};var ue=U({name:ie,props:de,emits:["delete","oversize","click-upload","close-preview","click-preview","update:modelValue"],setup(e,{emit:t,slots:o}){const s=ee(),c=(a=e.modelValue.length)=>({name:e.name,index:a}),w=()=>{s.value&&(s.value.value="")},y=a=>{if(w(),O(a,e.maxSize))if(Array.isArray(a)){const n=le(a,e.maxSize);if(a=n.valid,t("oversize",n.invalid,c()),!a.length)return}else{t("oversize",a,c());return}a=te(a),t("update:modelValue",[...e.modelValue,...L(a)]),e.afterRead&&e.afterRead(a,c())},g=a=>{const{maxCount:n,modelValue:u,resultType:f}=e;if(Array.isArray(a)){const m=+n-u.length;a.length>m&&(a=a.slice(0,m)),Promise.all(a.map(v=>R(v,f))).then(v=>{const T=a.map((_,S)=>{const V={file:_,status:"",message:""};return v[S]&&(V.content=v[S]),V});y(T)})}else R(a,f).then(m=>{const v={file:a,status:"",message:""};m&&(v.content=m),y(v)})},P=a=>{const{files:n}=a.target;if(e.disabled||!n||!n.length)return;const u=n.length===1?n[0]:[].slice.call(n);if(e.beforeRead){const f=e.beforeRead(u,c());if(!f){w();return}if(H(f)){f.then(m=>{g(m||u)}).catch(w);return}}g(u)};let r;const d=()=>t("close-preview"),p=a=>{if(e.previewFullImage){const n=e.modelValue.filter(B),u=n.map(f=>f.content||f.url).filter(Boolean);r=Q(z({images:u,startPosition:n.indexOf(a),onClose:d},e.previewOptions))}},b=()=>{r&&r.close()},x=(a,n)=>{const u=e.modelValue.slice(0);u.splice(n,1),t("update:modelValue",u),t("delete",a,c(n))},E=(a,n)=>{const u=["imageFit","deletable","previewSize","beforeDelete"],f=z(j(e,u),j(a,u,!0));return i(ce,ae({item:a,index:n,onClick:()=>t("click-preview",a,c(n)),onDelete:()=>x(a,n),onPreview:()=>p(a)},j(e,["name","lazyLoad"]),f),{"preview-cover":o["preview-cover"]})},N=()=>{if(e.previewImage)return e.modelValue.map(E)},C=a=>t("click-upload",a),M=()=>{if(e.modelValue.length>=e.maxCount||!e.showUpload)return;const a=e.readonly?null:i("input",{ref:s,type:"file",class:l("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:P},null);return o.default?i("div",{class:l("input-wrapper"),onClick:C},[o.default(),a]):i("div",{class:l("upload",{readonly:e.readonly}),style:A(e.previewSize),onClick:C},[i(F,{name:e.uploadIcon,class:l("upload-icon")},null),e.uploadText&&i("span",{class:l("upload-text")},[e.uploadText]),a])};return K({chooseFile:()=>{s.value&&!e.disabled&&s.value.click()},closeImagePreview:b}),ne(()=>e.modelValue),()=>i("div",{class:l()},[i("div",{class:l("wrapper",{disabled:e.disabled})},[N(),M()])])}});const Pe=J(ue);export{Pe as U};
