import{m as e,i as t,e as a,t as i,j as l,p as r}from"./use-translate.bf1abf23.js";import{c as n,w as o}from"./with-install.af140ae3.js";import{g as s}from"./unit.36efb2dd.js";import{u as d}from"./use-expose.028ef04d.js";import{I as u}from"./index.5afcfd01.js";import{I as c}from"./function-call.56e19f56.js";import{c as p}from"./interceptor.9b43abfe.js";import{I as m}from"./index.429cd099.js";import{L as f}from"./index.4893bdc2.js";import{B as v,f as g,C as b,G as w,L as y,H as x}from"./vendor.09b5b9a9.js";import{u as h}from"./index.e6355079.js";const[S,j]=n("uploader");function z(e){return Array.isArray(e)?e:[e]}function V(e,t){return new Promise((a=>{if("file"===t)return void a();const i=new FileReader;i.onload=e=>{a(e.target.result)},"dataUrl"===t?i.readAsDataURL(e):"text"===t&&i.readAsText(e)}))}function k(t,a){return z(t).some((t=>!!t.file&&(e(a)?a(t.file):t.file.size>a)))}const A=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i;function F(e){return!!e.isImage||(e.file&&e.file.type?0===e.file.type.indexOf("image"):e.url?(t=e.url,A.test(t)):"string"==typeof e.content&&0===e.content.indexOf("data:image"));var t}var C=v({props:{name:[Number,String],index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:[Number,String],beforeDelete:Function,item:{type:Object,required:!0}},emits:["delete","preview"],setup(e,{emit:i,slots:l}){const r=()=>{const{status:a,message:i}=e.item;if("uploading"===a||"failed"===a){const e="failed"===a?g(u,{name:"close",class:j("mask-icon")},null):g(f,{class:j("loading")},null),l=t(i)&&""!==i;return g("div",{class:j("mask")},[e,l&&g("div",{class:j("mask-message")},[i])])}},n=t=>{const{name:a,item:l,index:r,beforeDelete:n}=e;t.stopPropagation(),p({interceptor:n,args:[l,{name:a,index:r}],done:()=>i("delete")})},o=()=>i("preview"),d=()=>{if(e.deletable&&"uploading"!==e.item.status)return g("div",{class:j("preview-delete"),onClick:n},[g(u,{name:"cross",class:j("preview-delete-icon")},null)])},c=()=>{if(l["preview-cover"]){const{index:t,item:i}=e;return g("div",{class:j("preview-cover")},[l["preview-cover"](a({index:t},i))])}},v=()=>{const{item:t}=e;if(F(t)){let i;return g(m,{fit:e.imageFit,src:t.content||t.url,class:j("preview-image"),width:e.previewSize,height:e.previewSize,lazyLoad:e.lazyLoad,onClick:o},"function"==typeof(a=i=c())||"[object Object]"===Object.prototype.toString.call(a)&&!b(a)?i:{default:()=>[i]})}var a;return g("div",{class:j("file"),style:s(e.previewSize)},[g(u,{class:j("file-icon"),name:"description"},null),g("div",{class:[j("file-name"),"van-ellipsis"]},[t.file?t.file.name:t.url]),c()])};return()=>g("div",{class:j("preview")},[v(),r(),d()])}});const I=o(v({name:S,props:{capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,uploadText:String,deletable:i,afterRead:Function,showUpload:i,beforeRead:Function,beforeDelete:Function,previewSize:[Number,String],previewImage:i,previewOptions:Object,previewFullImage:i,name:{type:[Number,String],default:""},accept:{type:String,default:"image/*"},modelValue:{type:Array,default:()=>[]},maxSize:{type:[Number,String,Function],default:Number.MAX_VALUE},maxCount:{type:[Number,String],default:Number.MAX_VALUE},imageFit:{type:String,default:"cover"},resultType:{type:String,default:"dataUrl"},uploadIcon:{type:String,default:"photograph"}},emits:["delete","oversize","click-upload","close-preview","click-preview","update:modelValue"],setup(e,{emit:t,slots:i}){const n=w(),o=(t=e.modelValue.length)=>({name:e.name,index:t}),p=()=>{n.value&&(n.value.value="")},m=a=>{if(p(),k(a,e.maxSize)){if(!Array.isArray(a))return void t("oversize",a,o());{const i=function(e,t){const a=[],i=[];return e.forEach((e=>{k(e,t)?i.push(e):a.push(e)})),{valid:a,invalid:i}}(a,e.maxSize);if(a=i.valid,t("oversize",i.invalid,o()),!a.length)return}}a=x(a),t("update:modelValue",[...e.modelValue,...z(a)]),e.afterRead&&e.afterRead(a,o())},f=t=>{const{maxCount:a,modelValue:i,resultType:l}=e;if(Array.isArray(t)){const e=+a-i.length;t.length>e&&(t=t.slice(0,e)),Promise.all(t.map((e=>V(e,l)))).then((e=>{const a=t.map(((t,a)=>{const i={file:t,status:"",message:""};return e[a]&&(i.content=e[a]),i}));m(a)}))}else V(t,l).then((e=>{const a={file:t,status:"",message:""};e&&(a.content=e),m(a)}))},v=t=>{const{files:a}=t.target;if(e.disabled||!a||!a.length)return;const i=1===a.length?a[0]:[].slice.call(a);if(e.beforeRead){const t=e.beforeRead(i,o());if(!t)return void p();if(l(t))return void t.then((e=>{f(e||i)})).catch(p)}f(i)};let b;const S=()=>t("close-preview"),A=(l,n)=>{const s=["imageFit","deletable","previewSize","beforeDelete"],d=a(r(e,s),r(l,s,!0));return g(C,y({item:l,index:n,onClick:()=>t("click-preview",l,o(n)),onDelete:()=>((a,i)=>{const l=e.modelValue.slice(0);l.splice(i,1),t("update:modelValue",l),t("delete",a,o(i))})(l,n),onPreview:()=>(t=>{if(e.previewFullImage){const i=e.modelValue.filter(F),l=i.map((e=>e.content||e.url)).filter(Boolean);b=c(a({images:l,startPosition:i.indexOf(t),onClose:S},e.previewOptions))}})(l)},r(e,["name","lazyLoad"]),d),{"preview-cover":i["preview-cover"]})},I=()=>{if(e.previewImage)return e.modelValue.map(A)},L=e=>t("click-upload",e),N=()=>{if(e.modelValue.length>=e.maxCount||!e.showUpload)return;const t=e.readonly?null:g("input",{ref:n,type:"file",class:j("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:v},null);return i.default?g("div",{class:j("input-wrapper"),onClick:L},[i.default(),t]):g("div",{class:j("upload",{readonly:e.readonly}),style:s(e.previewSize),onClick:L},[g(u,{name:e.uploadIcon,class:j("upload-icon")},null),e.uploadText&&g("span",{class:j("upload-text")},[e.uploadText]),t])};return d({chooseFile:()=>{n.value&&!e.disabled&&n.value.click()},closeImagePreview:()=>{b&&b.close()}}),h((()=>e.modelValue)),()=>g("div",{class:j()},[g("div",{class:j("wrapper",{disabled:e.disabled})},[I(),N()])])}}));export{I as U};
