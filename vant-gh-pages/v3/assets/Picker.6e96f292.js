import{u as e,c as t,e as n,t as o}from"./use-translate.bf1abf23.js";import{c as a}from"./with-install.af140ae3.js";import{c as s}from"./constant.4d85ecb9.js";import{p as l}from"./event.7d40caae.js";import{u as i}from"./unit.36efb2dd.js";import{u as r}from"./use-expose.028ef04d.js";import{L as u}from"./index.4893bdc2.js";import{d as c}from"./deep-clone.be617e0e.js";import{c as m}from"./number.b01aa591.js";import{u as d}from"./use-touch.871001cd.js";import{B as f,G as p,H as b,z as v,f as g,E as h}from"./vendor.09b5b9a9.js";import{u as x}from"./useParent.60a302fe.js";import{u as y}from"./useChildren.692bc2bf.js";const[I,w]=a("picker-column");const C=Symbol(I);function N(e){return t(e)&&e.disabled}var H=f({name:I,props:{readonly:Boolean,allowHtml:Boolean,className:e,textKey:{type:String,required:!0},itemHeight:{type:Number,required:!0},swipeDuration:{type:[Number,String],required:!0},visibleItemCount:{type:[Number,String],required:!0},defaultIndex:{type:Number,default:0},initialOptions:{type:Array,default:()=>[]}},emits:["change"],setup(e,{emit:n,slots:o}){let a,s,i,u,f;const h=p(),y=b({index:e.defaultIndex,offset:0,duration:0,options:c(e.initialOptions)}),I=d(),H=()=>y.options.length,S=()=>e.itemHeight*(+e.visibleItemCount-1)/2,j=(t,o)=>{const s=-(t=(e=>{for(let t=e=m(e,0,H());t<H();t++)if(!N(y.options[t]))return t;for(let t=e-1;t>=0;t--)if(!N(y.options[t]))return t})(t)||0)*e.itemHeight,l=()=>{t!==y.index&&(y.index=t,o&&n("change",t))};a&&s!==y.offset?f=l:l(),y.offset=s},T=t=>{JSON.stringify(t)!==JSON.stringify(y.options)&&(y.options=c(t),j(e.defaultIndex))},V=n=>t(n)&&e.textKey in n?n[e.textKey]:n,k=t=>m(Math.round(-t/e.itemHeight),0,H()-1),B=()=>{a=!1,y.duration=0,f&&(f(),f=null)},D=t=>{if(!e.readonly){if(I.start(t),a){const e=function(e){const t=window.getComputedStyle(e),n=t.transform||t.webkitTransform,o=n.slice(7,n.length-1).split(", ")[5];return Number(o)}(h.value);y.offset=Math.min(0,e-S()),s=y.offset}else s=y.offset;y.duration=0,i=Date.now(),u=s,f=null}},O=t=>{if(e.readonly)return;I.move(t),I.isVertical()&&(a=!0,l(t,!0)),y.offset=m(s+I.deltaY.value,-H()*e.itemHeight,e.itemHeight);const n=Date.now();n-i>300&&(i=n,u=y.offset)},M=()=>{if(e.readonly)return;const t=y.offset-u,n=Date.now()-i;if(n<300&&Math.abs(t)>15)return void((t,n)=>{const o=Math.abs(t/n);t=y.offset+o/.003*(t<0?-1:1);const a=k(t);y.duration=+e.swipeDuration,j(a,!0)})(t,n);const o=k(y.offset);y.duration=200,j(o,!0),setTimeout((()=>{a=!1}),0)},K=()=>{const t={height:`${e.itemHeight}px`};return y.options.map(((n,s)=>{const l=V(n),i=N(n),r={role:"button",style:t,tabindex:i?-1:0,class:w("item",{disabled:i,selected:s===y.index}),onClick:()=>(t=>{a||e.readonly||(f=null,y.duration=200,j(t,!0))})(s)},u={class:"van-ellipsis",[e.allowHtml?"innerHTML":"textContent"]:l};return g("li",r,[o.option?o.option(n):g("div",u,null)])}))};return j(y.index),x(C),r({state:y,setIndex:j,getValue:()=>y.options[y.index],setValue:e=>{const{options:t}=y;for(let n=0;n<t.length;n++)if(V(t[n])===e)return j(n)},setOptions:T,stopMomentum:B}),v((()=>e.initialOptions),T),v((()=>e.defaultIndex),(e=>{j(e)})),()=>{const t={transform:`translate3d(0, ${y.offset+S()}px, 0)`,transitionDuration:`${y.duration}ms`,transitionProperty:y.duration?"all":"none"};return g("div",{class:[w(),e.className],onTouchstart:D,onTouchmove:O,onTouchend:M,onTouchcancel:M},[g("ul",{ref:h,style:t,class:w("wrapper"),onTransitionend:B},[K()])])}}});const[S,j,T]=a("picker"),V={title:String,loading:Boolean,readonly:Boolean,allowHtml:Boolean,showToolbar:o,cancelButtonText:String,confirmButtonText:String,itemHeight:{type:[Number,String],default:44},visibleItemCount:{type:[Number,String],default:6},swipeDuration:{type:[Number,String],default:1e3}};var k=f({name:S,props:n({},V,{valueKey:String,columnsFieldNames:Object,columns:{type:Array,default:()=>[]},defaultIndex:{type:[Number,String],default:0},toolbarPosition:{type:String,default:"top"}}),emits:["confirm","cancel","change"],setup(e,{emit:t,slots:o}){const a=p([]),{text:c,values:m,children:d}=n({text:e.valueKey||"text",values:"values",children:"children"},e.columnsFieldNames),{children:f,linkChildren:b}=y(C);b();const x=h((()=>i(e.itemHeight))),I=h((()=>{const t=e.columns[0];if("object"==typeof t){if(d in t)return"cascade";if(m in t)return"object"}return"plain"})),w=()=>f.map((e=>e.state.index)),N=(e,t)=>{const n=f[e];n&&n.setOptions(t)},S=t=>{let n={[d]:e.columns};const o=w();for(let e=0;e<=t;e++)n=n[d][o[e]];for(;n&&n[d];)t++,N(t,n[d]),n=n[d][n.defaultIndex||0]},V=e=>f[e],k=e=>{const t=V(e);if(t)return t.getValue()},B=(e,t)=>{const n=V(e);n&&(n.setValue(t),"cascade"===I.value&&S(e))},D=e=>{const t=V(e);if(t)return t.state.index},O=(e,t)=>{const n=V(e);n&&(n.setIndex(t),"cascade"===I.value&&S(e))},M=()=>f.map((e=>e.getValue())),K=e=>{"plain"===I.value?t(e,k(0),D(0)):t(e,M(),w())},$=()=>{f.forEach((e=>e.stopMomentum())),K("confirm")},P=()=>K("cancel"),q=()=>{const t=e.cancelButtonText||T("cancel");return g("button",{type:"button",class:j("cancel"),onClick:P},[o.cancel?o.cancel():t])},E=()=>{const t=e.confirmButtonText||T("confirm");return g("button",{type:"button",class:j("confirm"),onClick:$},[o.confirm?o.confirm():t])},z=()=>{if(e.showToolbar){const t=o.toolbar||o.default;return g("div",{class:j("toolbar")},[t?t():[q(),o.title?o.title():e.title?g("div",{class:[j("title"),"van-ellipsis"]},[e.title]):void 0,E()]])}},A=()=>a.value.map(((n,a)=>{var s;return g(H,{textKey:c,readonly:e.readonly,allowHtml:e.allowHtml,className:n.className,itemHeight:x.value,defaultIndex:null!=(s=n.defaultIndex)?s:+e.defaultIndex,swipeDuration:e.swipeDuration,initialOptions:n[m],visibleItemCount:e.visibleItemCount,onChange:()=>(e=>{"cascade"===I.value&&S(e),"plain"===I.value?t("change",k(0),D(0)):t("change",M(),e)})(a)},{option:o.option})})),F=()=>{const t=x.value*+e.visibleItemCount,n={height:`${x.value}px`},o={height:`${t}px`},a={backgroundSize:`100% ${(t-x.value)/2}px`};return g("div",{class:j("columns"),style:o,onTouchmove:l},[A(),g("div",{class:j("mask"),style:a},null),g("div",{class:[s,j("frame")],style:n},null)])};return v((()=>e.columns),(()=>{const{columns:t}=e;"plain"===I.value?a.value=[{[m]:t}]:"cascade"===I.value?(()=>{var t;const n=[];let o={[d]:e.columns};for(;o&&o[d];){const a=o[d];let s=null!=(t=o.defaultIndex)?t:+e.defaultIndex;for(;a[s]&&a[s].disabled;){if(!(s<a.length-1)){s=0;break}s++}n.push({[m]:o[d],className:o.className,defaultIndex:s}),o=a[s]}a.value=n})():a.value=t}),{immediate:!0}),r({confirm:$,getValues:M,setValues:e=>{e.forEach(((e,t)=>{B(t,e)}))},getIndexes:w,setIndexes:e=>{e.forEach(((e,t)=>{O(t,e)}))},getColumnIndex:D,setColumnIndex:O,getColumnValue:k,setColumnValue:B,getColumnValues:e=>{const t=V(e);if(t)return t.state.options},setColumnValues:N}),()=>{var t,n;return g("div",{class:j()},["top"===e.toolbarPosition?z():null,e.loading?g(u,{class:j("loading")},null):null,null==(t=o["columns-top"])?void 0:t.call(o),F(),null==(n=o["columns-bottom"])?void 0:n.call(o),"bottom"===e.toolbarPosition?z():null])}}});export{k as _,V as p};
